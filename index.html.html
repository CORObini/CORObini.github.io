<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSKí›„ê°í›ˆë ¨í‚¤íŠ¸(ê¸°ë¡ì¼ì§€)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .pastel-bg { background-color: #FEFBF6; }
        #landingPage {
            background-image: url('[í¬ê¸°ë³€í™˜]TOUCH250203-44.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .btn-primary {
            background-color: #A8D8B9;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #97C6A8;
        }
        .tab-btn {
            border-bottom: 4px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #A8D8B9;
            color: #333;
            font-weight: 700;
        }
        .intensity-btn.selected {
            background-color: #A8D8B9;
            color: white;
            transform: scale(1.1);
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        nav.scrolled {
            background-color: #F0F8FF; /* íŒŒìŠ¤í…” ë¸”ë£¨ */
            transition: background-color 0.3s ease-in-out;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="pastel-bg text-gray-800">

    <!-- 90ì¼ ì™„ë£Œ ì¶•í•˜ íŒì—… -->
    <div id="completionModal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-sm text-center transform transition-transform duration-300 scale-95">
            <h3 class="text-2xl font-bold mb-4">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</h3>
            <p class="text-lg font-bold mb-4">90ì¼ í›ˆë ¨ì„ ì™„ìˆ˜í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
            <div class="text-gray-700 space-y-3 mb-6 font-bold">
                <p>ê¾¸ì¤€í•œ ë…¸ë ¥ìœ¼ë¡œ 90ì¼ê°„ì˜ í›ˆë ¨ì„ ì„±ê³µì ìœ¼ë¡œ ë§ˆì¹˜ì…¨ìŠµë‹ˆë‹¤. ì •ë§ ëŒ€ë‹¨í•´ìš”!</p>
                <p>í›„ê° ì¬í™œ í›ˆë ¨ì€ ê¾¸ì¤€í•¨ì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤. ë§Œì•½ ì›í•˜ì‹œëŠ” ë§Œí¼ íšŒë³µì´ ë˜ì§€ ì•Šì•˜ë‹¤ë©´, ë‹¤ë¥¸ í‚¤íŠ¸ë¡œ ì¶”ê°€ í›ˆë ¨ì„ ì´ì–´ê°€ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
                <p>ë‹¹ì‹ ì˜ ë…¸ë ¥ì„ í•­ìƒ ì‘ì›í•©ë‹ˆë‹¤!</p>
            </div>
            <button id="closeCompletionModal" class="w-full btn-primary font-bold py-3 rounded-lg text-lg">í™•ì¸</button>
        </div>
    </div>


    <!-- ë©”ì‹œì§€ ì•Œë¦¼ìš© ìš”ì†Œ -->
    <div id="toastMessage" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300 z-50">
        <!-- ì„±ê³µ ë©”ì‹œì§€ ë™ì  ì‚½ì… -->
    </div>
    <div id="errorMessage" class="hidden fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300 z-50">
        <!-- ì—ëŸ¬ ë©”ì‹œì§€ ë™ì  ì‚½ì… -->
    </div>


    <!-- ëœë”© í˜ì´ì§€ (ìµœì´ˆ ì ‘ì† ì‹œ) -->
    <div id="landingPage" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <h1 class="text-2xl font-bold text-center mb-2">YSKí›„ê°í›ˆë ¨í‚¤íŠ¸</h1>
            <p class="text-center text-gray-600 mb-6 font-bold">(ê¸°ë¡ì¼ì§€)</p>
            
            <div class="mb-6">
                <label for="userNameInput" class="block text-lg font-bold mb-2">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</label>
                <input type="text" id="userNameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent" placeholder="í™ê¸¸ë™">
            </div>
            
            <button id="nextBtn" class="w-full btn-primary font-bold py-3 rounded-lg text-lg mt-8">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± í˜ì´ì§€ -->
    <div id="mainAppPage" class="hidden w-full max-w-2xl mx-auto bg-white min-h-screen shadow-2xl">
        <header class="p-4 sticky top-0 bg-white shadow-md z-30">
            <h2 class="text-xl font-bold"><span id="userNameDisplay"></span>ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</h2>
        </header>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav id="mainNav" class="flex justify-around border-b border-gray-200 sticky top-[68px] bg-white z-20">
            <button class="tab-btn py-3 px-4 text-gray-500 font-bold flex-1 text-center" data-tab="howToUse">ì‚¬ìš©ë°©ë²•</button>
            <button class="tab-btn py-3 px-4 text-gray-500 font-bold flex-1 text-center" data-tab="training">í›ˆë ¨í•˜ê¸°</button>
            <button class="tab-btn py-3 px-4 text-gray-500 font-bold flex-1 text-center" data-tab="record">í›ˆë ¨ê¸°ë¡</button>
        </nav>

        <main class="p-4 sm:p-6">
            <!-- 1. ì‚¬ìš©ë°©ë²• -->
            <div id="howToUseContent" class="tab-content space-y-6">
                <h3 class="text-xl font-bold mb-4">YSKí›„ê°í›ˆë ¨í‚¤íŠ¸ ì‚¬ìš©ë°©ë²•</h3>
                <div class="space-y-4 text-gray-700">
                    <div class="p-4 rounded-lg bg-green-50">
                        <h4 class="text-lg font-bold mb-2">- í›„ê°í›ˆë ¨ì´ë€?</h4>
                        <p class="font-bold text-base leading-relaxed">í›„ê°í›ˆë ¨ì€ í›„ê° ê¸°ëŠ¥ì´ ì €í•˜ë˜ê±°ë‚˜ ìƒì‹¤ëœ ê²½ìš° í›„ê°ì„ íšŒë³µì‹œí‚¤ê¸° ìœ„í•œ ì¬í™œ í›ˆë ¨ë²•ìœ¼ë¡œ, ê¾¸ì¤€í•œ ëƒ„ìƒˆ ìê·¹ê³¼ ì§‘ì¤‘ì„ í†µí•´ í›„ê° ì‹ ê²½ê³¼ ë‡Œì˜ ê¸°ëŠ¥ì„ í™œì„±í™”ì‹œí‚¤ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.</p>
                    </div>
                    <div class="p-4 rounded-lg bg-orange-50">
                        <h4 class="text-lg font-bold mb-2">- ì£¼ì˜ì‚¬í•­</h4>
                        <ul class="list-none space-y-2 font-bold text-base">
                            <li class="leading-relaxed">â€¢ ìµœì†Œ 6ê°œì›” ì´ìƒ ê¾¸ì¤€í•œ í›ˆë ¨ì„ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤.</li>
                            <li class="leading-relaxed">â€¢ ëƒ„ìƒˆë¥¼ ë§¡ì„ ë•Œ ì§‘ì¤‘í•˜ì—¬ ëƒ„ìƒˆë¥¼ ì¸ì§€í•˜ë ¤ ë…¸ë ¥í•˜ì‹œëŠ” ê²Œ ì¤‘ìš”í•©ë‹ˆë‹¤.</li>
                            <li class="leading-relaxed">â€¢ í›ˆë ¨ ì „ ê°€ê¹Œìš´ ì§€ì¸ì˜ ë„ì›€ìœ¼ë¡œ í–¥ì— ëŒ€í•´ì„œ ì„¤ëª…ì„ ë“¤ìœ¼ì‹œë©´ ì—°ìƒí•˜ëŠ”ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                    <div class="p-4 rounded-lg bg-violet-50">
                        <h4 class="text-lg font-bold mb-2">- í›„ê°í›ˆë ¨ ë°©ë²•</h4>
                        <div class="space-y-3 font-bold text-base">
                            <div class="leading-relaxed">
                                <p class="font-bold">1) í›ˆë ¨ ì‹œê°„ê³¼ ì£¼ê¸°</p>
                                <p class="ml-4">í•˜ë£¨ 10~20ë¶„ì”©, ì˜¤ì „ê³¼ ì˜¤í›„ í•˜ë£¨ ë‘ ë²ˆ í›ˆë ¨í•©ë‹ˆë‹¤.</p>
                            </div>
                            <div class="leading-relaxed">
                                <p class="font-bold">2) í›ˆë ¨ ë°©ë²•</p>
                                <p class="ml-4">ê° í–¥ê¸°ë¥¼ 10~15ì´ˆê°„ ê¹Šê²Œ ë§¡ì€ í›„, [í›ˆë ¨í•˜ê¸° íƒ­] í›„ê°ì¸ì§€ê°•ë„ë¥¼ ì„ íƒí•˜ì—¬ ì£¼ì‹œë©´ ë©ë‹ˆë‹¤. í–¥ê¸° ì‚¬ì´ì—ëŠ” 10~15ì´ˆ ì •ë„ íœ´ì‹ì„ ì·¨í•˜ë©° ëƒ„ìƒˆê°€ ë‚¨ì•„ìˆì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. 4ê°€ì§€ í–¥ì„ ìˆœì„œëŒ€ë¡œ ë§¡ëŠ” ê²ƒì„ 1ì„¸íŠ¸ë¡œ í•˜ì—¬ í•˜ë£¨ 2íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.</p>
                            </div>
                            <div class="leading-relaxed">
                                <p class="font-bold">3) ê°•ë„ í‰ê°€ ê¸°ì¤€</p>
                                <ul class="list-none ml-4 space-y-1">
                                    <li><strong>0:</strong> ì „í˜€ ëŠê»´ì§€ì§€ ì•ŠìŒ</li>
                                    <li><strong>1:</strong> ì•„ì£¼ ì•½í•˜ê²Œ ëŠê»´ì§</li>
                                    <li><strong>2:</strong> ì•½í•˜ê²Œ ëŠê»´ì§</li>
                                    <li><strong>3:</strong> ë³´í†µ ê°•ë„ë¡œ ëŠê»´ì§</li>
                                    <li><strong>4:</strong> ê°•í•˜ê²Œ ëŠê»´ì§</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. í›ˆë ¨í•˜ê¸° -->
            <div id="trainingContent" class="tab-content hidden">
                 <div class="text-center mb-6">
                    <p class="text-lg font-bold mb-3">í›ˆë ¨í•  í‚¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    <div id="trainingKitSelector" class="inline-flex rounded-lg shadow-sm" role="group">
                         <!-- í‚¤íŠ¸ ì„ íƒ ë²„íŠ¼ ë™ì  ìƒì„± -->
                    </div>
                </div>

                <div class="text-center mb-6">
                    <p class="text-lg font-bold mb-3">í›ˆë ¨ ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    <div id="sessionSelector" class="inline-flex rounded-lg shadow-sm" role="group">
                        <!-- ì‹œê°„ëŒ€ ì„ íƒ ë²„íŠ¼ ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <div id="scentTrainingContainer" class="space-y-6">
                    <!-- í–¥ê¸° í›ˆë ¨ í•­ëª©ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>

                <button id="saveTrainingBtn" class="w-full btn-primary font-bold py-3 rounded-lg text-lg mt-8">ì €ì¥í•˜ê¸°</button>
            </div>

            <!-- 3. í›ˆë ¨ê¸°ë¡ -->
            <div id="recordContent" class="tab-content hidden space-y-8">
                <div>
                     <h3 class="text-xl font-bold mb-4">ê¸°ë¡ ì¡°íšŒ í‚¤íŠ¸ ì„ íƒ</h3>
                     <div id="recordKitSelector" class="flex flex-wrap gap-2 mb-6">
                         <!-- ê¸°ë¡ ì¡°íšŒìš© í‚¤íŠ¸ ë²„íŠ¼ ë™ì  ìƒì„± -->
                     </div>
                </div>
                <div id="recordDetails" class="hidden">
                    <h3 class="text-xl font-bold mb-4">í›ˆë ¨ ì§„í–‰ ìƒí™©</h3>
                    <div class="bg-green-50 p-4 rounded-xl grid grid-cols-2 gap-4">
                        <div class="flex flex-col items-center justify-center">
                            <div class="relative w-28 h-28">
                                <svg class="w-full h-full" viewBox="0 0 36 36">
                                    <path class="text-gray-200" stroke-width="3" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <path id="progressCircle" class="text-green-500" stroke-width="3" fill="none" stroke-linecap="round" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                </svg>
                                <div id="progressPercent" class="absolute inset-0 flex items-center justify-center text-2xl font-bold">0%</div>
                            </div>
                        </div>
                        <div class="space-y-1 font-bold text-sm">
                            <p>ì‹œì‘ì¼: <span id="startDate" class="font-normal"></span></p>
                            <p>ì™„ë£Œì˜ˆì •ì¼: <span id="endDate" class="font-normal"></span></p>
                            <p>ë‚¨ì€ê¸°ê°„: <span id="daysLeft" class="font-normal"></span></p>
                            <p>ì§„í–‰íšŸìˆ˜: <span id="sessionsDone" class="font-normal"></span></p>
                            <p>ë¯¸ì§„í–‰íšŸìˆ˜: <span id="sessionsMissed" class="font-normal"></span></p>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold mt-8 mb-4">í›ˆë ¨ ê²°ê³¼ ê·¸ë˜í”„</h3>
                    <div class="mb-4">
                        <div id="chartFilterContainer" class="flex flex-wrap gap-2">
                             <!-- í•„í„° ë²„íŠ¼ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="recordChart"></canvas>
                    </div>
                </div>
                 <div id="noRecordMessage" class="text-center py-10 bg-gray-50 rounded-lg">
                    <p class="font-bold text-gray-500">ì„ íƒí•œ í‚¤íŠ¸ì— ëŒ€í•œ í›ˆë ¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const body = document.body;
            const landingPage = document.getElementById('landingPage');
            const mainAppPage = document.getElementById('mainAppPage');
            const nextBtn = document.getElementById('nextBtn');
            const userNameInput = document.getElementById('userNameInput');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const scentTrainingContainer = document.getElementById('scentTrainingContainer');
            const trainingKitSelector = document.getElementById('trainingKitSelector');
            const sessionSelector = document.getElementById('sessionSelector');
            const recordKitSelector = document.getElementById('recordKitSelector');
            const saveTrainingBtn = document.getElementById('saveTrainingBtn');
            const toastMessage = document.getElementById('toastMessage');
            const errorMessage = document.getElementById('errorMessage');
            const recordDetails = document.getElementById('recordDetails');
            const noRecordMessage = document.getElementById('noRecordMessage');
            const mainNav = document.getElementById('mainNav');
            const header = document.querySelector('header');
            const completionModal = document.getElementById('completionModal');
            const closeCompletionModal = document.getElementById('closeCompletionModal');


            const KITS = {
                '1': ['ì˜¤ë Œì§€', 'í´ë¡œë¸Œ', 'ë¼ë²¤ë”', 'ì‹œë”ìš°ë“œ'],
                '2': ['ë ˆëª¬', 'ì¼ë‘ì¼ë‘', 'ì†”í–¥', 'ë°”ë‹ë¼'],
                '3': ['ê¿€', 'ì˜¤ì´', 'ë°”ë‚˜ë‚˜', 'ë”¸ê¸°']
            };
            const TOTAL_SESSIONS = 180; // 90ì¼ * 2íšŒ

            const scentColors = {
                'ì˜¤ë Œì§€': 'bg-orange-100', 'í´ë¡œë¸Œ': 'bg-amber-200', 'ë¼ë²¤ë”': 'bg-purple-100', 'ì‹œë”ìš°ë“œ': 'bg-lime-100',
                'ë ˆëª¬': 'bg-yellow-100', 'ì¼ë‘ì¼ë‘': 'bg-yellow-200', 'ì†”í–¥': 'bg-green-100', 'ë°”ë‹ë¼': 'bg-stone-100',
                'ê¿€': 'bg-amber-100', 'ì˜¤ì´': 'bg-emerald-100', 'ë°”ë‚˜ë‚˜': 'bg-yellow-100', 'ë”¸ê¸°': 'bg-pink-100'
            };
            const intensityDescriptions = { 0: 'í–¥ì´ì•ˆë‚¨', 1: 'ì•„ì£¼ì•½í•¨', 2: 'ì•½í•¨', 3: 'ë³´í†µ', 4: 'ê°•í•¨' };

            let userData = {};
            let recordChart = null;
            let currentTrainingKit = '1';
            let currentRecordKit = '1';
            let currentSession = null;

            // ì•± ì´ˆê¸°í™” í•¨ìˆ˜
            function initializeApp() {
                const storedData = localStorage.getItem('olfactoryTrainingData');
                if (storedData) {
                    userData = JSON.parse(storedData);
                    if (!userData.records) userData.records = [];
                    if (!userData.completionNotified) userData.completionNotified = {};
                    landingPage.classList.add('hidden');
                    mainAppPage.classList.remove('hidden');
                    setupMainApp();
                } else {
                    landingPage.classList.remove('hidden');
                    mainAppPage.classList.add('hidden');
                }
            }
            
            nextBtn.addEventListener('click', () => {
                const name = userNameInput.value.trim();
                if (!name) {
                    showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', true);
                    return;
                }
                userData = { name: name, records: [], completionNotified: {} };
                localStorage.setItem('olfactoryTrainingData', JSON.stringify(userData));
                initializeApp();
            });

            function setupMainApp() {
                userNameDisplay.textContent = userData.name;
                setupTabs();
                renderTrainingPage(currentTrainingKit);
                renderRecordPage(currentRecordKit);
            }
            
            function setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                const defaultTab = 'training';
                tabContents.forEach(c => c.classList.add('hidden'));
                document.querySelector(`.tab-btn[data-tab="${defaultTab}"]`).classList.add('active');
                document.getElementById(`${defaultTab}Content`).classList.remove('hidden');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tab = button.dataset.tab;
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        tabContents.forEach(content => content.classList.add('hidden'));
                        document.getElementById(`${tab}Content`).classList.remove('hidden');
                        
                        if (tab === 'training') renderTrainingPage(currentTrainingKit);
                        if (tab === 'record') renderRecordPage(currentRecordKit);
                    });
                });
            }

            function renderSessionSelector() {
                sessionSelector.innerHTML = ['ì˜¤ì „', 'ì˜¤í›„'].map(session => {
                    const isActive = session === currentSession;
                    const activeClasses = 'bg-green-100 text-green-700 border-green-300 z-10';
                    const inactiveClasses = 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50';
                    return `
                        <button data-session="${session}" class="py-2 px-6 font-bold relative inline-flex items-center border -ml-px first:ml-0 first:rounded-l-lg last:rounded-r-lg ${isActive ? activeClasses : inactiveClasses}">
                            ${session}
                        </button>
                    `;
                }).join('');

                sessionSelector.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', e => {
                        const sessionButton = e.target.closest('[data-session]');
                        if (currentSession === sessionButton.dataset.session) {
                            currentSession = null; // Toggle off
                        } else {
                            currentSession = sessionButton.dataset.session;
                        }
                        renderSessionSelector();
                    });
                });
            }
            
            function renderTrainingPage(kitNumber) {
                currentTrainingKit = kitNumber;
                currentSession = null; // Reset session on kit change
                renderSessionSelector();
                
                trainingKitSelector.innerHTML = Object.keys(KITS).map(kit => {
                    const isActive = kit === kitNumber;
                    const activeClasses = 'bg-green-100 text-green-700 border-green-300 z-10';
                    const inactiveClasses = 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50';
                    return `<button data-kit="${kit}" class="py-2 px-6 font-bold relative inline-flex items-center border -ml-px first:ml-0 first:rounded-l-lg last:rounded-r-lg ${isActive ? activeClasses : inactiveClasses}">í‚¤íŠ¸ ${kit}</button>`;
                }).join('');

                trainingKitSelector.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const kitButton = e.target.closest('[data-kit]');
                        if (kitButton && kitButton.dataset.kit !== currentTrainingKit) {
                            renderTrainingPage(kitButton.dataset.kit);
                        }
                    });
                });

                const scents = KITS[kitNumber];
                scentTrainingContainer.innerHTML = '';
                scents.forEach((scent, index) => {
                    const bgColor = scentColors[scent] || 'bg-gray-50';
                    const scentBlock = `
                        <div class="${bgColor} p-4 rounded-lg shadow-sm">
                            <p class="text-lg font-bold mb-4 text-center">${scent}</p>
                            <div class="flex justify-around items-start text-center" data-scent-index="${index}">
                                ${[0, 1, 2, 3, 4].map(level => `
                                    <div class="flex flex-col items-center">
                                        <button class="intensity-btn w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 bg-white font-bold text-lg transition-transform duration-200" data-value="${level}">
                                            ${level}
                                        </button>
                                        <p class="text-xs font-bold text-gray-600 mt-2">${intensityDescriptions[level]}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    scentTrainingContainer.insertAdjacentHTML('beforeend', scentBlock);
                });

                scentTrainingContainer.querySelectorAll('.intensity-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const parent = e.target.closest('.flex');
                        parent.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('selected'));
                        e.target.classList.add('selected');
                    });
                });
            }

            saveTrainingBtn.addEventListener('click', () => {
                const today = new Date().toISOString().split('T')[0];
                
                const alreadyExists = userData.records.some(record => record.date === today && record.time === currentSession && record.kit === currentTrainingKit);
                if (alreadyExists) {
                    showToast('ì˜¤ëŠ˜ í•´ë‹¹ í‚¤íŠ¸ì™€ ì‹œê°„ì˜ ê¸°ë¡ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.', true);
                    return;
                }
                
                if (!currentSession) {
                    showToast('ì„ íƒì•ˆëœ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.', true);
                    return;
                }

                const intensities = [];
                const scentContainers = scentTrainingContainer.querySelectorAll('[data-scent-index]');
                let allSelected = true;

                scentContainers.forEach(container => {
                    const selectedBtn = container.querySelector('.intensity-btn.selected');
                    if (selectedBtn) {
                        intensities.push(parseInt(selectedBtn.dataset.value));
                    } else {
                        allSelected = false;
                    }
                });

                if (!allSelected) {
                    showToast('ì„ íƒì•ˆëœ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.', true);
                    return;
                }

                userData.records.push({ date: today, time: currentSession, kit: currentTrainingKit, intensities: intensities });
                localStorage.setItem('olfactoryTrainingData', JSON.stringify(userData));
                showToast('í›ˆë ¨ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                renderTrainingPage(currentTrainingKit); // Reset the training page
            });

            function renderRecordPage(kitNumber) {
                currentRecordKit = kitNumber;

                recordKitSelector.innerHTML = Object.keys(KITS).map(kit => `
                    <button class="px-4 py-2 text-sm font-bold rounded-full transition ${kit === kitNumber ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}" data-kit="${kit}">
                        í‚¤íŠ¸ ${kit}
                    </button>
                `).join('');

                recordKitSelector.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => renderRecordPage(e.target.dataset.kit));
                });

                const kitRecords = userData.records.filter(r => r.kit === kitNumber);

                if (kitRecords.length === 0) {
                    recordDetails.classList.add('hidden');
                    noRecordMessage.classList.remove('hidden');
                    return;
                }

                recordDetails.classList.remove('hidden');
                noRecordMessage.classList.add('hidden');

                const sessionsDone = kitRecords.length;
                const progress = Math.min(100, Math.round((sessionsDone / TOTAL_SESSIONS) * 100));
                
                const firstRecordDate = kitRecords.sort((a, b) => new Date(a.date) - new Date(b.date))[0].date;
                const startDate = new Date(firstRecordDate);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 90);
                const today = new Date();
                const daysLeft = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));
                const daysPassed = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
                const expectedSessions = daysPassed > 90 ? 180 : Math.max(0, (daysPassed + 1) * 2);
                
                document.getElementById('progressPercent').textContent = `${progress}%`;
                document.getElementById('progressCircle').setAttribute('stroke-dasharray', `${progress}, 100`);
                document.getElementById('startDate').textContent = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').textContent = endDate.toISOString().split('T')[0];
                document.getElementById('daysLeft').textContent = `${daysLeft}ì¼`;
                document.getElementById('sessionsDone').textContent = `${sessionsDone}íšŒ`;
                document.getElementById('sessionsMissed').textContent = `${Math.max(0, expectedSessions - sessionsDone)}íšŒ`;

                renderChart(kitNumber);
                
                // 90ì¼ ì™„ë£Œ ì²´í¬
                if (sessionsDone >= TOTAL_SESSIONS && !userData.completionNotified[kitNumber]) {
                    showCompletionModal(kitNumber);
                }
            }
            
            function renderChart(kitNumber, filterScent = 'ì „ì²´') {
                const scents = KITS[kitNumber];
                const chartFilterContainer = document.getElementById('chartFilterContainer');
                
                chartFilterContainer.innerHTML = '';
                ['ì „ì²´', ...scents].forEach(scent => {
                    const button = document.createElement('button');
                    button.textContent = scent;
                    button.className = `px-3 py-1 text-sm font-bold rounded-full transition ${scent === filterScent ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}`;
                    button.dataset.scent = scent;
                    button.addEventListener('click', () => renderChart(kitNumber, scent));
                    chartFilterContainer.appendChild(button);
                });
                
                const kitRecords = userData.records.filter(r => r.kit === kitNumber);
                const groupedRecords = kitRecords.reduce((acc, record) => {
                    if (!acc[record.date]) acc[record.date] = [];
                    acc[record.date].push(record.intensities);
                    return acc;
                }, {});

                const labels = Object.keys(groupedRecords).sort();
                const datasets = [];
                const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444'];
                
                if (filterScent === 'ì „ì²´') {
                    scents.forEach((scent, index) => {
                        datasets.push({
                            label: scent,
                            data: labels.map(date => {
                                const dayRecords = groupedRecords[date];
                                const sum = dayRecords.reduce((total, rec) => total + rec[index], 0);
                                return sum / dayRecords.length;
                            }),
                            borderColor: colors[index], backgroundColor: colors[index] + '33',
                            tension: 0.1, borderWidth: 2, pointRadius: 3, pointHoverRadius: 6,
                        });
                    });
                } else {
                    const scentIndex = scents.indexOf(filterScent);
                    datasets.push({
                        label: filterScent,
                        data: labels.map(date => {
                            const dayRecords = groupedRecords[date];
                            const sum = dayRecords.reduce((total, rec) => total + rec[scentIndex], 0);
                            return sum / dayRecords.length;
                        }),
                        borderColor: colors[scentIndex], backgroundColor: colors[scentIndex] + '33',
                        tension: 0.1, borderWidth: 2.5, pointRadius: 4, pointHoverRadius: 8,
                    });
                }
                
                const ctx = document.getElementById('recordChart').getContext('2d');
                if (recordChart) recordChart.destroy();
                recordChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 4, ticks: { stepSize: 1, font: { weight: 'bold' } } },
                            x: { ticks: { font: { weight: 'bold' }, autoSkip: true, maxTicksLimit: 10 } }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { font: { weight: 'bold' } } },
                            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                            tooltip: {
                                titleFont: { weight: 'bold' }, bodyFont: { weight: 'bold' },
                                callbacks: {
                                    label: context => `${context.dataset.label || ''}: ${context.parsed.y !== null ? context.parsed.y.toFixed(1) : ''}`
                                }
                            }
                        }
                    }
                });
            }
            
            function showToast(message, isError = false) {
                const toast = isError ? errorMessage : toastMessage;
                toast.textContent = message;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 2000); // 2ì´ˆ í›„ ì‚¬ë¼ì§
            }

            function showCompletionModal(kitNumber) {
                completionModal.classList.remove('hidden');
                setTimeout(() => {
                    completionModal.classList.remove('opacity-0');
                    completionModal.querySelector('.transform').classList.remove('scale-95');
                }, 10); // for transition
                
                userData.completionNotified[kitNumber] = true;
                localStorage.setItem('olfactoryTrainingData', JSON.stringify(userData));
            }

            closeCompletionModal.addEventListener('click', () => {
                completionModal.classList.add('opacity-0');
                completionModal.querySelector('.transform').classList.add('scale-95');
                setTimeout(() => {
                    completionModal.classList.add('hidden');
                }, 300); // match transition duration
            });


            // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì¶”ê°€
            window.addEventListener('scroll', () => {
                if (window.scrollY > header.offsetHeight) {
                    mainNav.classList.add('scrolled');
                } else {
                    mainNav.classList.remove('scrolled');
                }
            });

            initializeApp();
        });
    </script>
</body>
</html>

